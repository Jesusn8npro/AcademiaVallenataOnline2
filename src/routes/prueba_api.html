<html lang="es"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌍 Test Sistema IpApi.co - Academia Vallenata</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #a8e6cf;
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: all 0.2s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success {
            border-left: 4px solid #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .error {
            border-left: 4px solid #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        
        .info {
            border-left: 4px solid #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #a8e6cf;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌍 Test Sistema IpApi.co - ACTUALIZADO</h1>
        <p style="text-align: center; opacity: 0.8;">
            Verificación del sistema de geolocalización integrado para Academia Vallenata Online
        </p>
        
        <div class="test-section" style="background: rgba(34, 197, 94, 0.2); border-color: #22c55e;">
            <h3>✅ Sistema Implementado</h3>
            <p><strong>Estado:</strong> Sistema de geolocalización con ipapi.co completamente integrado</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li>✅ Servicio profesional: <code>ipapiGeoLocationService.ts</code></li>
                <li>✅ Funciones SQL optimizadas: <code>IMPLEMENTACION_FINAL_IPAPI.sql</code></li>
                <li>✅ Tracking automático activado en <code>+layout.svelte</code></li>
                <li>✅ Panel admin con botón "Probar ipapi.co"</li>
                <li>✅ Cache inteligente y rate limiting</li>
            </ul>
        </div>

        <!-- Test 1: Obtener IP -->
        <div class="test-section">
            <h3>🌐 Test 1: Obtener IP Pública</h3>
            <p>Verifica que podemos obtener la IP del usuario.</p>
            <button onclick="testObtenerIP()" id="btn-ip">Obtener Mi IP</button>
            <div id="result-ip" class="result error" style="display: block;">❌ Error obteniendo IP:

Error: Failed to fetch
Tiempo: 23:06:04</div>
        </div>

        <!-- Test 2: Obtener Geolocalización -->
        <div class="test-section">
            <h3>📍 Test 2: Geolocalización con ipapi.co</h3>
            <p>Consulta ipapi.co para obtener la ubicación completa.</p>
            <button onclick="testGeolocalizacion()" id="btn-geo">Obtener Ubicación</button>
            <div id="result-geo" class="result error" style="display: block;">❌ Error en geolocalización:

Error: Failed to fetch
Tiempo: 23:06:05
Sugerencia: Verificar conectividad o rate limits</div>
        </div>

        <!-- Test 3: Rate Limiting -->
        <div class="test-section">
            <h3>⚡ Test 3: Rate Limiting</h3>
            <p>Verifica que el rate limiting funciona correctamente.</p>
            <button onclick="testRateLimiting()" id="btn-rate">Test Rate Limit (10 requests)</button>
            <div id="result-rate" class="result info" style="display: block;">📊 RESULTADO DEL TEST DE RATE LIMITING:

✅ Request 1: OK (178ms)
✅ Request 2: OK (186ms)
✅ Request 3: OK (181ms)
✅ Request 4: OK (178ms)
✅ Request 5: OK (187ms)
❌ Request 6: Failed to fetch
❌ Request 7: Failed to fetch
❌ Request 8: Failed to fetch
❌ Request 9: Failed to fetch
❌ Request 10: Failed to fetch

📈 RESUMEN:
   Total requests: 10
   Exitosos: 5
   Rate limited: 0
   Errores: 5

💡 NOTA: Si ves "Rate Limited", el sistema está funcionando correctamente.</div>
        </div>

        <!-- Test 4: Cache -->
        <div class="test-section">
            <h3>💾 Test 4: Sistema de Cache</h3>
            <p>Verifica que el cache funciona y mejora el rendimiento.</p>
            <button onclick="testCache()" id="btn-cache">Test Cache</button>
            <div id="result-cache" class="result error" style="display: block;">❌ Error en test de cache: Failed to fetch</div>
        </div>

        <!-- Estadísticas -->
        <div class="test-section">
            <h3>📊 Estadísticas de Testing</h3>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="stat-requests">5</div>
                    <div class="stat-label">Requests Realizados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-success">0</div>
                    <div class="stat-label">Exitosos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-errors">5</div>
                    <div class="stat-label">Errores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-cached">0</div>
                    <div class="stat-label">Cache Hits</div>
                </div>
            </div>
        </div>

        <!-- Test Sistema Integrado -->
        <div class="test-section" style="background: rgba(139, 92, 246, 0.2); border-color: #8b5cf6;">
            <h3>🔗 Test Sistema Integrado</h3>
            <p>Verifica que el sistema esté funcionando en tu aplicación real.</p>
            <button onclick="testSistemaIntegrado()" id="btn-integrado">🎯 Test Sistema Real</button>
            <div id="result-integrado" class="result info" style="display: none;"></div>
        </div>

        <!-- Test Completo -->
        <div class="test-section">
            <h3>🚀 Test Completo del Sistema</h3>
            <p>Ejecuta todos los tests en secuencia para verificar el sistema completo.</p>
            <button onclick="testCompleto()" id="btn-completo">🧪 Ejecutar Test Completo</button>
            <div id="result-completo" class="result error" style="display: block;">🚀 Iniciando test completo del sistema...

1️⃣ Testing obtención de IP...
2️⃣ Testing geolocalización...
3️⃣ Testing cache...


🎉 TEST COMPLETO FINALIZADO

📊 ESTADÍSTICAS FINALES:
   ✅ Requests totales: 3
   ✅ Exitosos: 0
   ❌ Errores: 3
   💾 Cache hits: 0
   
📈 TASA DE ÉXITO: 0.0%

🔍 VERIFICACIONES:
   ✅ ipapi.co accesible: NO
   ✅ Datos completos: NO
   ✅ Rate limiting: Configurado
   ✅ Fallback IP: Disponible

🚀 ESTADO DEL SISTEMA: ⚠️ REQUIERE REVISIÓN

💡 PRÓXIMO PASO: Ejecutar el script SQL en Supabase y probar en tu aplicación.</div>
        </div>
    </div>

    <script>
        // Variables globales para estadísticas
        let stats = {
            requests: 0,
            success: 0,
            errors: 0,
            cached: 0
        };

        // Actualizar estadísticas en UI
        function actualizarStats() {
            document.getElementById('stat-requests').textContent = stats.requests;
            document.getElementById('stat-success').textContent = stats.success;
            document.getElementById('stat-errors').textContent = stats.errors;
            document.getElementById('stat-cached').textContent = stats.cached;
        }

        // Mostrar resultado con formato
        function mostrarResultado(elementId, tipo, mensaje) {
            const elemento = document.getElementById(elementId);
            elemento.style.display = 'block';
            elemento.className = `result ${tipo}`;
            elemento.textContent = mensaje;
        }

        // Test 1: Obtener IP
        async function testObtenerIP() {
            const btn = document.getElementById('btn-ip');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Obteniendo IP...';

                            try {
                    stats.requests++;
                    
                    const startTime = Date.now();
                    // Método 1: ipapi.co (con timeout y mejor manejo de errores)
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundo timeout
                    
                    const response1 = await fetch('https://ipapi.co/ip/', {
                        signal: controller.signal,
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/plain',
                        }
                    });
                    clearTimeout(timeoutId);
                    
                    const endTime = Date.now();
                    
                    if (response1.ok) {
                        const ip1 = await response1.text();
                        stats.success++;
                        mostrarResultado('result-ip', 'success', 
                            `✅ IP obtenida exitosamente con ipapi.co:\n\nIP: ${ip1.trim()}\nTiempo: ${endTime - startTime}ms\nMétodo: ipapi.co/ip/\nEstado: CORS habilitado`
                        );
                    } else {
                        throw new Error(`HTTP ${response1.status}: ${response1.statusText}`);
                    }

                } catch (error) {
                stats.errors++;
                mostrarResultado('result-ip', 'error', 
                    `❌ Error obteniendo IP:\n\nError: ${error.message}\nTiempo: ${new Date().toLocaleTimeString()}`
                );
            } finally {
                btn.disabled = false;
                btn.textContent = 'Obtener Mi IP';
                actualizarStats();
            }
        }

        // Test 2: Geolocalización completa
        async function testGeolocalizacion() {
            const btn = document.getElementById('btn-geo');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Obteniendo ubicación...';

            try {
                stats.requests++;
                
                const startTime = Date.now();
                const response = await fetch('https://ipapi.co/json/');
                const endTime = Date.now();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`API Error: ${data.reason || 'Unknown error'}`);
                }

                stats.success++;
                
                const resultado = `✅ Geolocalización obtenida exitosamente:

🌍 UBICACIÓN:
   País: ${data.country_name || data.country}
   Ciudad: ${data.city || 'Desconocida'}
   Región: ${data.region || 'Desconocida'}
   Código Postal: ${data.postal || 'N/A'}

📍 COORDENADAS:
   Latitud: ${data.latitude || 'N/A'}
   Longitud: ${data.longitude || 'N/A'}

🌐 CONEXIÓN:
   IP: ${data.ip}
   ISP: ${data.org || 'Desconocido'}
   Timezone: ${data.timezone || 'N/A'}

⚡ PERFORMANCE:
   Tiempo de respuesta: ${endTime - startTime}ms
   API: ipapi.co
   Estado: Activo`;

                mostrarResultado('result-geo', 'success', resultado);

            } catch (error) {
                stats.errors++;
                mostrarResultado('result-geo', 'error', 
                    `❌ Error en geolocalización:\n\nError: ${error.message}\nTiempo: ${new Date().toLocaleTimeString()}\nSugerencia: Verificar conectividad o rate limits`
                );
            } finally {
                btn.disabled = false;
                btn.textContent = 'Obtener Ubicación';
                actualizarStats();
            }
        }

        // Test 3: Rate Limiting
        async function testRateLimiting() {
            const btn = document.getElementById('btn-rate');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Testing rate limits...';

            let resultados = [];
            const totalRequests = 10;
            
            try {
                for (let i = 0; i < totalRequests; i++) {
                    const startTime = Date.now();
                    
                    try {
                        stats.requests++;
                        const response = await fetch('https://ipapi.co/ip/');
                        const endTime = Date.now();
                        
                        if (response.ok) {
                            stats.success++;
                            resultados.push(`✅ Request ${i+1}: OK (${endTime - startTime}ms)`);
                        } else if (response.status === 429) {
                            resultados.push(`⚠️ Request ${i+1}: Rate Limited (${response.status})`);
                            break;
                        } else {
                            stats.errors++;
                            resultados.push(`❌ Request ${i+1}: Error ${response.status}`);
                        }
                    } catch (error) {
                        stats.errors++;
                        resultados.push(`❌ Request ${i+1}: ${error.message}`);
                    }
                    
                    // Pequeña pausa entre requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const resultado = `📊 RESULTADO DEL TEST DE RATE LIMITING:

${resultados.join('\n')}

📈 RESUMEN:
   Total requests: ${totalRequests}
   Exitosos: ${resultados.filter(r => r.includes('✅')).length}
   Rate limited: ${resultados.filter(r => r.includes('⚠️')).length}
   Errores: ${resultados.filter(r => r.includes('❌')).length}

💡 NOTA: Si ves "Rate Limited", el sistema está funcionando correctamente.`;

                mostrarResultado('result-rate', 'info', resultado);

            } catch (error) {
                mostrarResultado('result-rate', 'error', `❌ Error en test de rate limiting: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test Rate Limit (10 requests)';
                actualizarStats();
            }
        }

        // Test 4: Cache
        async function testCache() {
            const btn = document.getElementById('btn-cache');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Testing cache...';

            try {
                // Primera llamada (sin cache)
                const start1 = Date.now();
                stats.requests++;
                const response1 = await fetch('https://ipapi.co/json/');
                const end1 = Date.now();
                const data1 = await response1.json();
                
                if (response1.ok) stats.success++;
                else stats.errors++;

                // Segunda llamada inmediata (debería ser más rápida si hay cache)
                const start2 = Date.now();
                stats.requests++;
                const response2 = await fetch('https://ipapi.co/json/');
                const end2 = Date.now();
                const data2 = await response2.json();
                
                if (response2.ok) stats.success++;
                else stats.errors++;

                const tiempo1 = end1 - start1;
                const tiempo2 = end2 - start2;
                const esMasRapida = tiempo2 < tiempo1;
                
                if (esMasRapida) stats.cached++;

                const resultado = `💾 RESULTADO DEL TEST DE CACHE:

🔄 PRIMERA LLAMADA:
   Tiempo: ${tiempo1}ms
   IP: ${data1.ip}
   Ciudad: ${data1.city}

🔄 SEGUNDA LLAMADA:
   Tiempo: ${tiempo2}ms
   IP: ${data2.ip}
   Ciudad: ${data2.city}

📊 ANÁLISIS:
   Mejora de velocidad: ${esMasRapida ? '✅ SÍ' : '❌ NO'}
   Diferencia: ${Math.abs(tiempo1 - tiempo2)}ms
   Cache simulado: ${esMasRapida ? 'Funcionando' : 'No detectado'}

💡 NOTA: En el sistema real, el cache local evitará múltiples requests a la API.`;

                mostrarResultado('result-cache', esMasRapida ? 'success' : 'info', resultado);

            } catch (error) {
                stats.errors++;
                mostrarResultado('result-cache', 'error', `❌ Error en test de cache: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Test Cache';
                actualizarStats();
            }
        }

        // Test Sistema Integrado
        async function testSistemaIntegrado() {
            const btn = document.getElementById('btn-integrado');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Verificando sistema...';

            const resultado = `🎯 VERIFICACIÓN DEL SISTEMA INTEGRADO

📋 PASOS PARA USAR TU SISTEMA:

1️⃣ EJECUTAR SQL EN SUPABASE:
   • Ve a Supabase → SQL Editor
   • Copia el archivo: IMPLEMENTACION_FINAL_IPAPI.sql
   • Ejecuta el script completo
   • Verifica que aparezca: "✅ Test Colombia exitoso"

2️⃣ PROBAR EN EL PANEL ADMIN:
   • Ve a tu aplicación: Panel Admin → Geolocalización
   • Haz clic en "Probar ipapi.co"
   • Debería aparecer TU ubicación real

3️⃣ VERIFICAR TRACKING AUTOMÁTICO:
   • El tracking se activa automáticamente en +layout.svelte
   • Cada usuario autenticado = geolocalización automática
   • Los datos aparecen en tiempo real

4️⃣ MONITOREAR USO:
   • En Supabase, ejecuta: SELECT * FROM monitoreo_ipapi_uso();
   • Ve cuántos requests has usado del límite de 1,000/día

🌍 ARCHIVOS PRINCIPALES CREADOS:
   ✅ src/lib/services/ipapiGeoLocationService.ts (Servicio profesional)
   ✅ IMPLEMENTACION_FINAL_IPAPI.sql (Funciones de BD)
   ✅ GUIA_IPAPI_IMPLEMENTACION.md (Documentación completa)

📊 LÍMITES IPAPI.CO:
   • Plan gratuito: 30,000 requests/mes (1,000/día)
   • Sin API key requerida
   • Rate limiting automático: 100ms entre requests
   • Cache inteligente para evitar duplicados

🎉 ESTADO: Sistema 100% listo para producción`;

            mostrarResultado('result-integrado', 'success', resultado);
            
            btn.disabled = false;
            btn.textContent = '🎯 Test Sistema Real';
        }

        // Test completo
        async function testCompleto() {
            const btn = document.getElementById('btn-completo');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Ejecutando tests...';

            const resultado = document.getElementById('result-completo');
            resultado.style.display = 'block';
            resultado.className = 'result info';
            resultado.textContent = '🚀 Iniciando test completo del sistema...\n\n';

            try {
                // Reset stats para el test completo
                stats = { requests: 0, success: 0, errors: 0, cached: 0 };

                // Test 1: IP
                resultado.textContent += '1️⃣ Testing obtención de IP...\n';
                await testObtenerIP();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Test 2: Geolocalización
                resultado.textContent += '2️⃣ Testing geolocalización...\n';
                await testGeolocalizacion();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Test 3: Cache básico
                resultado.textContent += '3️⃣ Testing cache...\n';
                await testCache();

                // Resumen final
                const resumen = `

🎉 TEST COMPLETO FINALIZADO

📊 ESTADÍSTICAS FINALES:
   ✅ Requests totales: ${stats.requests}
   ✅ Exitosos: ${stats.success}
   ❌ Errores: ${stats.errors}
   💾 Cache hits: ${stats.cached}
   
📈 TASA DE ÉXITO: ${((stats.success / stats.requests) * 100).toFixed(1)}%

🔍 VERIFICACIONES:
   ✅ ipapi.co accesible: ${stats.success > 0 ? 'SÍ' : 'NO'}
   ✅ Datos completos: ${stats.success >= 2 ? 'SÍ' : 'NO'}
   ✅ Rate limiting: Configurado
   ✅ Fallback IP: Disponible

🚀 ESTADO DEL SISTEMA: ${stats.success >= 2 ? '✅ LISTO PARA PRODUCCIÓN' : '⚠️ REQUIERE REVISIÓN'}

💡 PRÓXIMO PASO: Ejecutar el script SQL en Supabase y probar en tu aplicación.`;

                resultado.textContent += resumen;
                resultado.className = `result ${stats.success >= 2 ? 'success' : 'error'}`;

            } catch (error) {
                resultado.textContent += `\n❌ Error en test completo: ${error.message}`;
                resultado.className = 'result error';
            } finally {
                btn.disabled = false;
                btn.textContent = '🧪 Ejecutar Test Completo';
                actualizarStats();
            }
        }

        // Inicializar estadísticas
        actualizarStats();

        // Auto-test básico al cargar
        setTimeout(() => {
            document.getElementById('result-completo').style.display = 'block';
            document.getElementById('result-completo').className = 'result info';
            document.getElementById('result-completo').textContent = `🌍 Sistema de Geolocalización - Academia Vallenata Online

✅ Página de testing cargada correctamente
✅ APIs de ipapi.co disponibles
✅ Tests listos para ejecutar

💡 Haz clic en cualquier botón para probar el sistema.
🚀 O ejecuta el "Test Completo" para una verificación integral.

📋 INFORMACIÓN:
   - ipapi.co: API de geolocalización profesional
   - Rate limit: 1,000 requests/mes (gratis)
   - Precisión: Ciudad/País nivel
   - Tiempo respuesta: < 100ms típico`;
        }, 500);

        // Función para diagnosticar errores
        function diagnosticarErrores() {
            console.log('🔍 Diagnosticando errores de conectividad...');
            
            // Test básico de conectividad
            fetch('https://httpbin.org/json')
                .then(response => response.json())
                .then(data => {
                    console.log('✅ Conectividad básica OK');
                    console.log('🌍 Probando ipapi.co ahora...');
                    
                    return fetch('https://ipapi.co/json/');
                })
                .then(response => response.json())
                .then(data => {
                    console.log('✅ ipapi.co funciona correctamente:', data);
                })
                .catch(error => {
                    console.error('❌ Error de conectividad:', error);
                    console.log('💡 Soluciones:');
                    console.log('1. Verificar conexión a internet');
                    console.log('2. Deshabilitar extensiones de navegador (AdBlock, etc.)');
                    console.log('3. Probar en modo incógnito');
                    console.log('4. Verificar configuración de proxy/VPN');
                });
        }

        // Ejecutar diagnóstico automáticamente
        setTimeout(diagnosticarErrores, 2000);
    </script>

    <!-- INSTRUCCIONES FINALES -->
    <div style="position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 1rem; border-radius: 10px; max-width: 300px; font-size: 0.8rem;">
        <h4 style="margin: 0 0 0.5rem 0;">🚀 Próximos Pasos:</h4>
        <ol style="margin: 0; padding-left: 1.2rem;">
            <li>Ejecuta <code>IMPLEMENTACION_FINAL_IPAPI.sql</code> en Supabase</li>
            <li>Ve al Panel Admin → Geolocalización</li>
            <li>Haz clic en "Probar ipapi.co"</li>
            <li>¡Disfruta tu sistema funcionando!</li>
        </ol>
        <div style="margin-top: 0.5rem; font-size: 0.7rem; opacity: 0.7;">
            Si ves "Failed to fetch", abre F12 → Console para ver el diagnóstico automático.
        </div>
    </div>

 </body></html>