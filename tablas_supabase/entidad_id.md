[
  {
    "routine_name": "notificar_evento_creado",
    "routine_definition": "\r\nBEGIN\r\n    -- Solo notificar cuando se crea un evento O cuando se hace p√∫blico\r\n    IF TG_OP = 'INSERT' OR \r\n       (TG_OP = 'UPDATE' AND OLD.es_publico IS DISTINCT FROM NEW.es_publico AND NEW.es_publico = true) THEN\r\n        \r\n        -- Solo si el evento es p√∫blico\r\n        IF NEW.es_publico = true THEN\r\n            \r\n            INSERT INTO notificaciones (\r\n                usuario_id,\r\n                tipo,\r\n                titulo,\r\n                mensaje,\r\n                icono,\r\n                categoria,\r\n                prioridad,\r\n                url_accion,\r\n                entidad_id,\r\n                entidad_tipo,\r\n                datos_adicionales\r\n            )\r\n            SELECT \r\n                p.id,\r\n                'nuevo_evento',\r\n                'üé™ ¬°Nuevo evento disponible!',\r\n                'Evento: \"' || NEW.titulo || '\"' ||\r\n                CASE \r\n                    WHEN NEW.descripcion_corta IS NOT NULL \r\n                    THEN E'\\nüìù ' || NEW.descripcion_corta \r\n                    ELSE '' \r\n                END ||\r\n                CASE \r\n                    WHEN NEW.fecha_inicio IS NOT NULL \r\n                    THEN E'\\nüìÖ ' || TO_CHAR(NEW.fecha_inicio, 'DD/MM/YYYY HH24:MI')\r\n                    ELSE '' \r\n                END ||\r\n                CASE \r\n                    WHEN NEW.instructor_nombre IS NOT NULL \r\n                    THEN E'\\nüë®‚Äçüè´ ' || NEW.instructor_nombre \r\n                    ELSE '' \r\n                END ||\r\n                CASE \r\n                    WHEN NEW.precio IS NOT NULL AND NEW.precio > 0 \r\n                    THEN E'\\nüí∞ $' || NEW.precio::text || ' COP'\r\n                    ELSE E'\\nüíö ¬°GRATIS!'\r\n                END ||\r\n                E'\\n\\n¬°Inscr√≠bete ya! üöÄ',\r\n                'üé™',\r\n                'contenido', -- ‚úÖ CATEGOR√çA CORREGIDA\r\n                CASE WHEN NEW.es_destacado = true THEN 'alta' ELSE 'normal' END,\r\n                '/eventos/' || NEW.slug,\r\n                NEW.id,\r\n                'evento',\r\n                jsonb_build_object(\r\n                    'evento_titulo', NEW.titulo,\r\n                    'fecha_inicio', NEW.fecha_inicio,\r\n                    'instructor', NEW.instructor_nombre,\r\n                    'precio', NEW.precio,\r\n                    'tipo_evento', NEW.tipo_evento\r\n                )\r\n            FROM perfiles p\r\n            WHERE p.eliminado = false\r\n            ON CONFLICT DO NOTHING;\r\n            \r\n        END IF;\r\n        \r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "routine_name": "crear_notificacion_segura",
    "routine_definition": "\r\nDECLARE\r\n    nueva_notificacion_id UUID;\r\nBEGIN\r\n    INSERT INTO notificaciones (\r\n        usuario_id,\r\n        tipo,\r\n        titulo,\r\n        mensaje,\r\n        categoria,\r\n        prioridad,\r\n        url_accion,\r\n        icono,\r\n        entidad_id,\r\n        entidad_tipo,\r\n        datos_adicionales,\r\n        leida,\r\n        archivada,\r\n        fecha_expiracion\r\n    ) VALUES (\r\n        p_usuario_id,\r\n        p_tipo,\r\n        p_titulo,\r\n        p_mensaje,\r\n        p_categoria,\r\n        p_prioridad,\r\n        p_url_accion,\r\n        p_icono,\r\n        p_entidad_id,  -- Puede ser NULL\r\n        p_entidad_tipo,\r\n        p_datos_adicionales,\r\n        false,\r\n        false,\r\n        NOW() + INTERVAL '30 days'\r\n    ) RETURNING id INTO nueva_notificacion_id;\r\n    \r\n    RETURN nueva_notificacion_id;\r\nEND;\r\n"
  },
  {
    "routine_name": "crear_notificacion",
    "routine_definition": "\r\nDECLARE\r\n    nueva_notificacion_id UUID;\r\n    preferencias_usuario RECORD;\r\nBEGIN\r\n    -- Verificar si el usuario tiene habilitadas estas notificaciones\r\n    SELECT * INTO preferencias_usuario \r\n    FROM notificaciones_preferencias \r\n    WHERE usuario_id = p_usuario_id \r\n    AND tipo_notificacion = p_tipo;\r\n    \r\n    -- Si no hay preferencias, crear con defaults habilitados\r\n    -- Si las hay y est√°n deshabilitadas, no crear la notificaci√≥n\r\n    IF FOUND AND NOT preferencias_usuario.habilitado THEN\r\n        RETURN NULL;\r\n    END IF;\r\n    \r\n    -- Crear la notificaci√≥n\r\n    INSERT INTO notificaciones (\r\n        usuario_id, tipo, titulo, mensaje, categoria,\r\n        url_accion, entidad_id, entidad_tipo, icono, prioridad, datos_adicionales\r\n    ) VALUES (\r\n        p_usuario_id, p_tipo, p_titulo, p_mensaje, p_categoria,\r\n        p_url_accion, p_entidad_id, p_entidad_tipo, p_icono, p_prioridad, p_datos_adicionales\r\n    ) RETURNING id INTO nueva_notificacion_id;\r\n    \r\n    RETURN nueva_notificacion_id;\r\nEND;\r\n"
  },
  {
    "routine_name": "crear_notificacion_evento",
    "routine_definition": "\r\nBEGIN\r\n    -- Solo para eventos p√∫blicos activos\r\n    IF NEW.es_publico = true AND NEW.estado IN ('programado', 'activo') AND \r\n       (TG_OP = 'INSERT' OR (TG_OP = 'UPDATE' AND OLD.estado != NEW.estado)) THEN\r\n        \r\n        INSERT INTO notificaciones (\r\n            usuario_id,\r\n            tipo,\r\n            titulo,\r\n            mensaje,\r\n            icono,\r\n            categoria,\r\n            prioridad,\r\n            url_accion,\r\n            entidad_id,\r\n            entidad_tipo,\r\n            datos_adicionales,\r\n            fecha_expiracion\r\n        )\r\n        SELECT \r\n            p.id,\r\n            'nuevo_evento',\r\n            'üé™ ¬°Nuevo evento programado!',\r\n            'üéØ \"' || NEW.titulo || '\"' || E'\\n\\nüìÖ ' || \r\n            to_char(NEW.fecha_inicio, 'DD/MM/YYYY HH24:MI') || \r\n            CASE \r\n                WHEN NEW.es_gratuito = true THEN E'\\nüíö ¬°Evento GRATUITO!'\r\n                ELSE E'\\nüí∞ Precio: $' || COALESCE(NEW.precio::text, '0')\r\n            END ||\r\n            E'\\nüé≠ Tipo: ' || COALESCE(NEW.tipo_evento, 'evento') ||\r\n            E'\\n\\n¬°No te lo pierdas! Inscr√≠bete ahora.',\r\n            'üé™',\r\n            'contenido',\r\n            CASE WHEN NEW.es_gratuito = true THEN 'alta' ELSE 'media' END,\r\n            '/eventos/' || NEW.slug,\r\n            NEW.id::text,\r\n            'evento',\r\n            jsonb_build_object(\r\n                'titulo_evento', NEW.titulo,\r\n                'fecha_inicio', NEW.fecha_inicio,\r\n                'es_gratuito', NEW.es_gratuito,\r\n                'precio', NEW.precio,\r\n                'tipo_evento', NEW.tipo_evento\r\n            ),\r\n            NEW.fecha_inicio + INTERVAL '1 hour'\r\n        FROM perfiles p\r\n        WHERE p.eliminado = false OR p.eliminado IS NULL;\r\n        \r\n        RAISE NOTICE 'üé™ Evento: Notificaci√≥n creada para evento \"%\"', NEW.titulo;\r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "routine_name": "crear_notificacion_like",
    "routine_definition": "\r\nDECLARE\r\n    publicacion_datos RECORD;\r\n    autor_id uuid;\r\nBEGIN\r\n    -- Solo para nuevos likes (INSERT)\r\n    IF TG_OP = 'INSERT' THEN\r\n        \r\n        -- Obtener datos de la publicaci√≥n y autor\r\n        SELECT p.titulo, p.usuario_id, p.tipo, p.usuario_nombre\r\n        INTO publicacion_datos\r\n        FROM comunidad_publicaciones p\r\n        WHERE p.id = NEW.publicacion_id;\r\n        \r\n        autor_id := publicacion_datos.usuario_id;\r\n        \r\n        -- Solo notificar al autor si no es √©l mismo quien dio like\r\n        IF autor_id != NEW.usuario_id AND autor_id IS NOT NULL THEN\r\n            \r\n            -- Obtener nombre del usuario que dio like\r\n            INSERT INTO notificaciones (\r\n                usuario_id,\r\n                tipo,\r\n                titulo,\r\n                mensaje,\r\n                icono,\r\n                categoria,\r\n                prioridad,\r\n                url_accion,\r\n                entidad_id,\r\n                entidad_tipo,\r\n                datos_adicionales,\r\n                fecha_expiracion\r\n            )\r\n            SELECT \r\n                autor_id,\r\n                'like_publicacion',\r\n                'üëç ¬°Alguien le gust√≥ tu publicaci√≥n!',\r\n                'üéâ A ' || COALESCE(p.nombre_completo, p.nombre_usuario, 'un usuario') || \r\n                ' le gust√≥ tu ' || COALESCE(publicacion_datos.tipo, 'publicaci√≥n') ||\r\n                E'\\n\\nüìù \"' || LEFT(publicacion_datos.titulo, 100) || \r\n                CASE WHEN LENGTH(publicacion_datos.titulo) > 100 THEN '...' ELSE '' END || '\"' ||\r\n                E'\\n\\n¬°Sigue compartiendo contenido genial! üöÄ',\r\n                'üëç',\r\n                'comunidad',\r\n                'baja',\r\n                '/comunidad',\r\n                NEW.publicacion_id::text,\r\n                'like',\r\n                jsonb_build_object(\r\n                    'titulo_publicacion', publicacion_datos.titulo,\r\n                    'tipo_publicacion', publicacion_datos.tipo,\r\n                    'usuario_like_id', NEW.usuario_id,\r\n                    'usuario_like_nombre', COALESCE(p.nombre_completo, p.nombre_usuario)\r\n                ),\r\n                NOW() + INTERVAL '7 days'\r\n            FROM perfiles p\r\n            WHERE p.id = NEW.usuario_id;\r\n            \r\n            RAISE NOTICE 'üëç Like: Notificaci√≥n enviada al autor de la publicaci√≥n \"%\"', publicacion_datos.titulo;\r\n        END IF;\r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "routine_name": "crear_notificacion_comentario",
    "routine_definition": "\r\nDECLARE\r\n    publicacion_datos RECORD;\r\n    autor_publicacion_id uuid;\r\n    comentario_padre_autor_id uuid;\r\nBEGIN\r\n    -- Solo para nuevos comentarios (INSERT)\r\n    IF TG_OP = 'INSERT' THEN\r\n        \r\n        -- Obtener datos de la publicaci√≥n\r\n        SELECT p.titulo, p.usuario_id, p.tipo\r\n        INTO publicacion_datos\r\n        FROM comunidad_publicaciones p\r\n        WHERE p.id = NEW.publicacion_id;\r\n        \r\n        autor_publicacion_id := publicacion_datos.usuario_id;\r\n        \r\n        -- 1. Notificar al autor de la publicaci√≥n (si no es el mismo que comenta)\r\n        IF autor_publicacion_id != NEW.usuario_id AND autor_publicacion_id IS NOT NULL THEN\r\n            INSERT INTO notificaciones (\r\n                usuario_id,\r\n                tipo,\r\n                titulo,\r\n                mensaje,\r\n                icono,\r\n                categoria,\r\n                prioridad,\r\n                url_accion,\r\n                entidad_id,\r\n                entidad_tipo,\r\n                datos_adicionales,\r\n                fecha_expiracion\r\n            )\r\n            VALUES (\r\n                autor_publicacion_id,\r\n                'comentario_publicacion',\r\n                'üí¨ ¬°Nuevo comentario en tu publicaci√≥n!',\r\n                'üó®Ô∏è ' || NEW.usuario_nombre || ' coment√≥ en tu ' || COALESCE(publicacion_datos.tipo, 'publicaci√≥n') ||\r\n                E'\\n\\nüìù \"' || LEFT(publicacion_datos.titulo, 80) || \r\n                CASE WHEN LENGTH(publicacion_datos.titulo) > 80 THEN '...' ELSE '' END || '\"' ||\r\n                E'\\n\\nüí≠ \"' || LEFT(NEW.comentario, 120) || \r\n                CASE WHEN LENGTH(NEW.comentario) > 120 THEN '...' ELSE '' END || '\"' ||\r\n                E'\\n\\n¬°Ve a ver qu√© dice! üèÉ‚Äç‚ôÇÔ∏è',\r\n                'üí¨',\r\n                'comunidad',\r\n                'media',\r\n                '/comunidad',\r\n                NEW.publicacion_id::text,\r\n                'comentario',\r\n                jsonb_build_object(\r\n                    'titulo_publicacion', publicacion_datos.titulo,\r\n                    'comentario_autor', NEW.usuario_nombre,\r\n                    'comentario_preview', LEFT(NEW.comentario, 200),\r\n                    'comentario_id', NEW.id\r\n                ),\r\n                NOW() + INTERVAL '10 days'\r\n            );\r\n            \r\n            RAISE NOTICE 'üí¨ Comentario: Notificaci√≥n enviada al autor de la publicaci√≥n \"%\"', publicacion_datos.titulo;\r\n        END IF;\r\n        \r\n        -- 2. Si es respuesta a otro comentario, notificar al autor del comentario padre\r\n        IF NEW.comentario_padre_id IS NOT NULL THEN\r\n            SELECT usuario_id INTO comentario_padre_autor_id\r\n            FROM comunidad_comentarios \r\n            WHERE id = NEW.comentario_padre_id;\r\n            \r\n            -- Notificar al autor del comentario padre (si no es el mismo que responde ni el autor de la publicaci√≥n)\r\n            IF comentario_padre_autor_id IS NOT NULL AND \r\n               comentario_padre_autor_id != NEW.usuario_id AND \r\n               comentario_padre_autor_id != autor_publicacion_id THEN\r\n                \r\n                INSERT INTO notificaciones (\r\n                    usuario_id,\r\n                    tipo,\r\n                    titulo,\r\n                    mensaje,\r\n                    icono,\r\n                    categoria,\r\n                    prioridad,\r\n                    url_accion,\r\n                    entidad_id,\r\n                    entidad_tipo,\r\n                    datos_adicionales,\r\n                    fecha_expiracion\r\n                )\r\n                VALUES (\r\n                    comentario_padre_autor_id,\r\n                    'respuesta_comentario',\r\n                    '‚Ü©Ô∏è ¬°Alguien respondi√≥ tu comentario!',\r\n                    'üéØ ' || NEW.usuario_nombre || ' te respondi√≥:' ||\r\n                    E'\\n\\nüí≠ \"' || LEFT(NEW.comentario, 150) || \r\n                    CASE WHEN LENGTH(NEW.comentario) > 150 THEN '...' ELSE '' END || '\"' ||\r\n                    E'\\n\\nüìù En la publicaci√≥n: \"' || LEFT(publicacion_datos.titulo, 80) || '\"' ||\r\n                    E'\\n\\n¬°Ve a continuar la conversaci√≥n! üó£Ô∏è',\r\n                    '‚Ü©Ô∏è',\r\n                    'comunidad',\r\n                    'media',\r\n                    '/comunidad',\r\n                    NEW.publicacion_id::text,\r\n                    'respuesta',\r\n                    jsonb_build_object(\r\n                        'titulo_publicacion', publicacion_datos.titulo,\r\n                        'respuesta_autor', NEW.usuario_nombre,\r\n                        'respuesta_preview', LEFT(NEW.comentario, 200),\r\n                        'comentario_padre_id', NEW.comentario_padre_id,\r\n                        'comentario_id', NEW.id\r\n                    ),\r\n                    NOW() + INTERVAL '10 days'\r\n                );\r\n                \r\n                RAISE NOTICE '‚Ü©Ô∏è Respuesta: Notificaci√≥n enviada al autor del comentario padre';\r\n            END IF;\r\n        END IF;\r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "routine_name": "probar_notificacion_curso_manual",
    "routine_definition": "\r\nDECLARE\r\n    curso_data RECORD;\r\n    total_usuarios INTEGER;\r\n    notificaciones_creadas INTEGER;\r\nBEGIN\r\n    -- Obtener datos del curso\r\n    SELECT * INTO curso_data FROM cursos WHERE id = curso_id_param;\r\n    \r\n    IF curso_data IS NULL THEN\r\n        RAISE NOTICE '‚ùå No se encontr√≥ curso con ID: %', curso_id_param;\r\n        RETURN;\r\n    END IF;\r\n    \r\n    -- Contar usuarios activos\r\n    SELECT COUNT(*) INTO total_usuarios \r\n    FROM perfiles \r\n    WHERE (eliminado = false OR eliminado IS NULL);\r\n    \r\n    RAISE NOTICE 'üìä INFO DEL CURSO:';\r\n    RAISE NOTICE '   T√≠tulo: %', curso_data.titulo;\r\n    RAISE NOTICE '   Estado: %', COALESCE(curso_data.estado, 'NULL');\r\n    RAISE NOTICE '   Es P√∫blico: %', COALESCE(curso_data.es_publico::text, 'NULL');\r\n    RAISE NOTICE '   Usuarios activos: %', total_usuarios;\r\n    \r\n    -- Crear notificaciones manualmente\r\n    INSERT INTO notificaciones (\r\n        usuario_id,\r\n        tipo,\r\n        titulo,\r\n        mensaje,\r\n        icono,\r\n        categoria,\r\n        prioridad,\r\n        url_accion,\r\n        entidad_id,\r\n        entidad_tipo,\r\n        datos_adicionales,\r\n        fecha_expiracion\r\n    )\r\n    SELECT \r\n        p.id,\r\n        'nuevo_curso',\r\n        'üéì ¬°Nuevo curso disponible! (MANUAL)',\r\n        'üöÄ \"' || curso_data.titulo || '\"' || \r\n        E'\\n\\nüìö ' || COALESCE(curso_data.descripcion_corta, LEFT(curso_data.descripcion, 150)) ||\r\n        E'\\n\\n¬°Inscr√≠bete ahora y comienza a aprender! üéØ',\r\n        'üéì',\r\n        'contenido',\r\n        'alta',\r\n        '/cursos/' || COALESCE(curso_data.slug, curso_data.id::text),\r\n        curso_data.id,\r\n        'curso',\r\n        jsonb_build_object('titulo_curso', curso_data.titulo, 'manual', true),\r\n        NOW() + INTERVAL '30 days'\r\n    FROM perfiles p\r\n    WHERE (p.eliminado = false OR p.eliminado IS NULL);\r\n    \r\n    GET DIAGNOSTICS notificaciones_creadas = ROW_COUNT;\r\n    \r\n    RAISE NOTICE '‚úÖ Notificaciones creadas manualmente: %', notificaciones_creadas;\r\nEND;\r\n"
  },
  {
    "routine_name": "notificar_curso",
    "routine_definition": "\r\nBEGIN\r\n    -- Solo para INSERT o cuando se publica\r\n    IF TG_OP = 'INSERT' OR \r\n       (TG_OP = 'UPDATE' AND OLD.estado IS DISTINCT FROM NEW.estado AND NEW.estado = 'publicado') OR\r\n       (TG_OP = 'UPDATE' AND OLD.es_publico IS DISTINCT FROM NEW.es_publico AND NEW.es_publico = true) THEN\r\n        \r\n        -- Insertar notificaci√≥n usando valores REALES\r\n        INSERT INTO notificaciones (\r\n            usuario_id,\r\n            tipo,\r\n            titulo,\r\n            mensaje,\r\n            icono,\r\n            categoria,\r\n            prioridad,\r\n            url_accion,\r\n            entidad_id,\r\n            entidad_tipo,\r\n            datos_adicionales\r\n        )\r\n        SELECT \r\n            p.id,\r\n            'nuevo_curso',\r\n            'üéì ¬°Nuevo curso disponible!',\r\n            'El curso \"' || NEW.titulo || '\" ya est√° disponible' ||\r\n            CASE \r\n                WHEN NEW.descripcion_corta IS NOT NULL \r\n                THEN E'\\n\\n' || NEW.descripcion_corta \r\n                ELSE '' \r\n            END ||\r\n            CASE \r\n                WHEN NEW.nivel IS NOT NULL \r\n                THEN E'\\nüìä Nivel: ' || NEW.nivel \r\n                ELSE '' \r\n            END ||\r\n            CASE \r\n                WHEN NEW.precio_normal IS NOT NULL AND NEW.precio_normal > 0 \r\n                THEN E'\\nüí∞ Precio: $' || NEW.precio_normal::text\r\n                ELSE E'\\nüíö ¬°GRATIS!'\r\n            END,\r\n            'üéì',\r\n            'contenido',\r\n            CASE WHEN NEW.es_destacado = true THEN 'alta' ELSE 'normal' END,\r\n            '/cursos/' || COALESCE(NEW.slug, NEW.id::text),\r\n            NEW.id,\r\n            'curso',\r\n            jsonb_build_object(\r\n                'curso_titulo', NEW.titulo,\r\n                'nivel', NEW.nivel,\r\n                'categoria', NEW.categoria,\r\n                'destacado', NEW.es_destacado\r\n            )\r\n        FROM perfiles p\r\n        WHERE p.eliminado = false\r\n        ON CONFLICT DO NOTHING; -- Evitar duplicados\r\n        \r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "routine_name": "notificar_tutorial",
    "routine_definition": "\r\nBEGIN\r\n    -- Solo para INSERT o cuando se publica\r\n    IF TG_OP = 'INSERT' OR \r\n       (TG_OP = 'UPDATE' AND OLD.estado IS DISTINCT FROM NEW.estado AND NEW.estado = 'publicado') THEN\r\n        \r\n        INSERT INTO notificaciones (\r\n            usuario_id,\r\n            tipo,\r\n            titulo,\r\n            mensaje,\r\n            icono,\r\n            categoria,\r\n            prioridad,\r\n            url_accion,\r\n            entidad_id,\r\n            entidad_tipo,\r\n            datos_adicionales\r\n        )\r\n        SELECT \r\n            p.id,\r\n            'nuevo_tutorial',\r\n            'üéµ ¬°Nuevo tutorial disponible!',\r\n            'Tutorial de \"' || NEW.titulo || '\" ya disponible' ||\r\n            CASE \r\n                WHEN NEW.artista IS NOT NULL \r\n                THEN E'\\nüé§ Artista: ' || NEW.artista \r\n                ELSE '' \r\n            END ||\r\n            CASE \r\n                WHEN NEW.acordeonista IS NOT NULL \r\n                THEN E'\\nü™ó Acordeonista: ' || NEW.acordeonista \r\n                ELSE '' \r\n            END ||\r\n            CASE \r\n                WHEN NEW.tonalidad IS NOT NULL \r\n                THEN E'\\nüéº Tonalidad: ' || NEW.tonalidad \r\n                ELSE '' \r\n            END ||\r\n            CASE \r\n                WHEN NEW.precio_normal IS NOT NULL AND NEW.precio_normal > 0 \r\n                THEN E'\\nüí∞ Precio: $' || NEW.precio_normal::text\r\n                ELSE E'\\nüíö ¬°GRATIS!'\r\n            END,\r\n            'üéµ',\r\n            'contenido',\r\n            CASE WHEN NEW.destacado = true THEN 'alta' ELSE 'normal' END,\r\n            '/tutoriales/' || NEW.id::text,\r\n            NEW.id,\r\n            'tutorial',\r\n            jsonb_build_object(\r\n                'tutorial_titulo', NEW.titulo,\r\n                'artista', NEW.artista,\r\n                'acordeonista', NEW.acordeonista,\r\n                'tonalidad', NEW.tonalidad,\r\n                'destacado', NEW.destacado\r\n            )\r\n        FROM perfiles p\r\n        WHERE p.eliminado = false\r\n        ON CONFLICT DO NOTHING; -- Evitar duplicados\r\n        \r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "routine_name": "notificar_like",
    "routine_definition": "\r\nDECLARE\r\n    publicacion_info RECORD;\r\n    usuario_like_nombre TEXT;\r\nBEGIN\r\n    IF TG_OP = 'INSERT' THEN\r\n        \r\n        -- Obtener info de la publicaci√≥n\r\n        SELECT titulo, usuario_id, usuario_nombre, tipo\r\n        INTO publicacion_info\r\n        FROM comunidad_publicaciones \r\n        WHERE id = NEW.publicacion_id;\r\n        \r\n        -- Obtener nombre del usuario que dio like\r\n        SELECT COALESCE(nombre_completo, nombre_usuario, 'Un usuario')\r\n        INTO usuario_like_nombre\r\n        FROM perfiles\r\n        WHERE id = NEW.usuario_id;\r\n        \r\n        -- Solo notificar al autor (no al que dio like)\r\n        IF publicacion_info.usuario_id != NEW.usuario_id AND publicacion_info.usuario_id IS NOT NULL THEN\r\n            \r\n            INSERT INTO notificaciones (\r\n                usuario_id,\r\n                tipo,\r\n                titulo,\r\n                mensaje,\r\n                icono,\r\n                categoria,\r\n                prioridad,\r\n                url_accion,\r\n                entidad_id,\r\n                entidad_tipo,\r\n                datos_adicionales\r\n            )\r\n            VALUES (\r\n                publicacion_info.usuario_id,\r\n                'like_recibido',\r\n                'üëç ¬°Te dieron like!',\r\n                usuario_like_nombre || ' le gust√≥ tu ' || publicacion_info.tipo || \r\n                E'\\n\"' || LEFT(publicacion_info.titulo, 100) || '\"',\r\n                'üëç',\r\n                'comunidad',\r\n                'baja',\r\n                '/comunidad',\r\n                NEW.publicacion_id,\r\n                'publicacion',\r\n                jsonb_build_object(\r\n                    'publicacion_titulo', publicacion_info.titulo,\r\n                    'usuario_like', usuario_like_nombre,\r\n                    'tipo_publicacion', publicacion_info.tipo\r\n                )\r\n            )\r\n            ON CONFLICT DO NOTHING;\r\n            \r\n        END IF;\r\n        \r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEND;\r\n"
  },
  {
    "routine_name": "notificar_comentario",
    "routine_definition": "\r\nDECLARE\r\n    publicacion_info RECORD;\r\n    comentario_padre_info RECORD;\r\nBEGIN\r\n    IF TG_OP = 'INSERT' THEN\r\n        \r\n        -- Obtener info de la publicaci√≥n\r\n        SELECT titulo, usuario_id, usuario_nombre, tipo\r\n        INTO publicacion_info\r\n        FROM comunidad_publicaciones \r\n        WHERE id = NEW.publicacion_id;\r\n        \r\n        -- Si es respuesta a comentario\r\n        IF NEW.comentario_padre_id IS NOT NULL THEN\r\n            \r\n            -- Obtener info del comentario padre\r\n            SELECT usuario_id, usuario_nombre\r\n            INTO comentario_padre_info\r\n            FROM comunidad_comentarios\r\n            WHERE id = NEW.comentario_padre_id;\r\n            \r\n            -- Notificar al autor del comentario padre (no al que comenta)\r\n            IF comentario_padre_info.usuario_id != NEW.usuario_id THEN\r\n                \r\n                INSERT INTO notificaciones (\r\n                    usuario_id,\r\n                    tipo,\r\n                    titulo,\r\n                    mensaje,\r\n                    icono,\r\n                    categoria,\r\n                    prioridad,\r\n                    url_accion,\r\n                    entidad_id,\r\n                    entidad_tipo,\r\n                    datos_adicionales\r\n                )\r\n                VALUES (\r\n                    comentario_padre_info.usuario_id,\r\n                    'respuesta_comentario',\r\n                    'üí¨ Respuesta a tu comentario',\r\n                    NEW.usuario_nombre || ' respondi√≥ a tu comentario' ||\r\n                    E'\\n\"' || LEFT(NEW.comentario, 100) || '\"',\r\n                    'üí¨',\r\n                    'comunidad',\r\n                    'normal',\r\n                    '/comunidad',\r\n                    NEW.publicacion_id,\r\n                    'comentario',\r\n                    jsonb_build_object(\r\n                        'comentario_texto', NEW.comentario,\r\n                        'usuario_responde', NEW.usuario_nombre,\r\n                        'publicacion_titulo', publicacion_info.titulo\r\n                    )\r\n                )\r\n                ON CONFLICT DO NOTHING;\r\n                \r\n            END IF;\r\n            \r\n        ELSE\r\n            -- Es comentario nuevo en publicaci√≥n\r\n            -- Notificar al autor de la publicaci√≥n (no al que comenta)\r\n            IF publicacion_info.usuario_id != NEW.usuario_id THEN\r\n                \r\n                INSERT INTO notificaciones (\r\n                    usuario_id,\r\n                    tipo,\r\n                    titulo,\r\n                    mensaje,\r\n                    icono,\r\n                    categoria,\r\n                    prioridad,\r\n                    url_accion,\r\n                    entidad_id,\r\n                    entidad_tipo,\r\n                    datos_adicionales\r\n                )\r\n                VALUES (\r\n                    publicacion_info.usuario_id,\r\n                    'nuevo_comentario',\r\n                    'üí¨ Nuevo comentario',\r\n                    NEW.usuario_nombre || ' coment√≥ en tu ' || publicacion_info.tipo ||\r\n                    E'\\n\"' || LEFT(NEW.comentario, 100) || '\"',\r\n                    'üí¨',\r\n                    'comunidad',\r\n                    'normal',\r\n                    '/comunidad',\r\n                    NEW.publicacion_id,\r\n                    'comentario',\r\n                    jsonb_build_object(\r\n                        'comentario_texto', NEW.comentario,\r\n                        'usuario_comenta', NEW.usuario_nombre,\r\n                        'publicacion_titulo', publicacion_info.titulo\r\n                    )\r\n                )\r\n                ON CONFLICT DO NOTHING;\r\n                \r\n            END IF;\r\n            \r\n        END IF;\r\n        \r\n    END IF;\r\n    \r\n    RETURN NEW;\r\nEND;\r\n"
  }
]